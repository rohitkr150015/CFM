CREATE DATABASE coursefiledb;
USE coursefiledb;
-- Table: Institute
CREATE TABLE Institute (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    address TEXT,
    email VARCHAR(100),
    phone VARCHAR(20),
    website VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table: Department
CREATE TABLE Department (
    id INT AUTO_INCREMENT PRIMARY KEY,
    institute_id INT,
    name VARCHAR(200),
    code VARCHAR(50),
    hod_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (institute_id) REFERENCES Institute(id) ON DELETE CASCADE
);

-- Table: Teacher
CREATE TABLE Teacher(
    id INT AUTO_INCREMENT PRIMARY KEY,
    department_id INT,
    name VARCHAR(150) NOT NULL,
    employee_code VARCHAR(100) UNIQUE NOT NULL,
    designation VARCHAR(100),
    email_official VARCHAR(150),
    contact_number VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    joined_on DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (department_id) REFERENCES Department(id) ON DELETE CASCADE
);


-- Table: Notification
CREATE TABLE Notification(
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    type VARCHAR(50),
    payload JSON,
    is_read BOOLEAN,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES Teacher(id) ON DELETE CASCADE
);

-- Table: User
CREATE TABLE User(
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    role VARCHAR(50),
    teacher_id INT,
    is_active BOOLEAN,
    last_login TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (teacher_id) REFERENCES Teacher(id) ON DELETE CASCADE
);

-- Table: Activity_Log
CREATE TABLE Activity_Log(
    id INT AUTO_INCREMENT PRIMARY KEY,
    actor_id INT,
    action VARCHAR(100),
    target_type VARCHAR(50),
    target_id INT,
    details JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (actor_id) REFERENCES Teacher(id)
);

-- Table: Program
CREATE TABLE Program(
    id INT AUTO_INCREMENT PRIMARY KEY,
    department_id INT,
    name VARCHAR(200),
    code VARCHAR(50),
    duration_year INT,
    degree_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (department_id) REFERENCES Department(id) ON DELETE CASCADE
);

-- Table: Branch
CREATE TABLE Branch(
    id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT,
    name VARCHAR(200),
    code VARCHAR(50),
    FOREIGN KEY (program_id) REFERENCES Program(id) ON DELETE CASCADE
);

-- Table: Semester
CREATE TABLE Semester(
    id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT,
    branch_id INT,
    semester_number INT,
    label VARCHAR(50),
    FOREIGN KEY (program_id) REFERENCES Program(id) ON DELETE CASCADE,
    FOREIGN KEY (branch_id) REFERENCES Branch(id) ON DELETE CASCADE
);

-- Table: Course
CREATE TABLE Course(
    id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT,
    branch_id INT,
    semester_id INT,
    code VARCHAR(50),
    title VARCHAR(200),
    credits INT,
    contact_hour INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (program_id) REFERENCES Program(id) ON DELETE CASCADE,
    FOREIGN KEY (branch_id) REFERENCES Branch(id) ON DELETE CASCADE,
    FOREIGN KEY (semester_id) REFERENCES Semester(id) ON DELETE CASCADE
);

-- Table: Course_File
CREATE TABLE Course_File(
    id INT AUTO_INCREMENT PRIMARY KEY,
    course_id INT,
    academic_year VARCHAR(20),
    created_by INT,
    status VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_id) REFERENCES Course(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES Teacher(id) ON DELETE CASCADE
);

-- Table: Approval
CREATE TABLE Approval(
    id INT AUTO_INCREMENT PRIMARY KEY,
    course_file_id INT,
    approver_id INT,
    stage VARCHAR(30),
    status VARCHAR(20),
    comment TEXT,
    acted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_file_id) REFERENCES Course_File(id) ON DELETE CASCADE,
    FOREIGN KEY (approver_id) REFERENCES Teacher(id) ON DELETE CASCADE
);

-- Table: Course_Teacher
CREATE TABLE Course_Teacher(
    id INT AUTO_INCREMENT PRIMARY KEY,
    course_id INT,
    teacher_id INT,
    section VARCHAR(10),
    academic_year VARCHAR(20),
    FOREIGN KEY (course_id) REFERENCES Course(id) ON DELETE CASCADE,
    FOREIGN KEY (teacher_id) REFERENCES Teacher(id) ON DELETE CASCADE
);

-- Table: Heading
CREATE TABLE Heading(
    id INT AUTO_INCREMENT PRIMARY KEY,
    course_file_id INT,
    parent_heading_id INT,
    title VARCHAR(255),
    order_index INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_file_id) REFERENCES Course_File(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_heading_id) REFERENCES Heading(id) ON DELETE CASCADE
);

-- Table: Document
CREATE TABLE Document(
    id INT AUTO_INCREMENT PRIMARY KEY,
    heading_id INT,
    uploaded_by INT,
    file_name VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,
    type VARCHAR(100),
    file_size BIGINT NOT NULL,
    version_no INT,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (heading_id) REFERENCES Heading(id) ON DELETE CASCADE,
    FOREIGN KEY (uploaded_by) REFERENCES Teacher(id) ON DELETE CASCADE
);

-- Table: Comment
CREATE TABLE Comment(
    id INT AUTO_INCREMENT PRIMARY KEY,
    course_file_id INT,
    heading_id INT,
    document_id INT,
    author_id INT,
    text TEXT,
    parent_comment_id INT,
    is_received BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_file_id) REFERENCES Course_File(id) ON DELETE CASCADE,
    FOREIGN KEY (heading_id) REFERENCES Heading(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES Document(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES Teacher(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_comment_id) REFERENCES Comment(id) ON DELETE CASCADE
);

-- Table: Template
CREATE TABLE Template(
    id INT AUTO_INCREMENT PRIMARY KEY,
    department_id INT,
    name VARCHAR(200),
    description TEXT,
    structure JSON,
    checklist JSON,
    created_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (department_id) REFERENCES Department(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES Teacher(id) ON DELETE CASCADE
);
